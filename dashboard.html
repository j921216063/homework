<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投資組合績效儀表板 (2025 專業報告版)</title>
    
    <!-- 1. 樣式 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* PDF 隱藏渲染區 (強制桌面寬度 1280px, A4 橫向比例優化) */
        #pdf-hidden-zone { 
            position: fixed; 
            top: 0; 
            left: -15000px; 
            width: 1280px; 
            z-index: -100; 
            background-color: white; 
        }
        .pdf-page { 
            width: 1280px; 
            min-height: 900px; /* A4 Landscape Ratio approx */
            padding: 60px; /* 增加內距，讓版面更寬敞 */
            background: white; 
            margin-bottom: 20px; 
            position: relative; 
            box-sizing: border-box;
        }
        /* 用於強制分頁的空白佔位 */
        .pdf-spacer {
            height: 50px;
        }
        
        @media print { .no-print { display: none !important; } }
    </style>

    <!-- 2. React 17 -->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Recharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.10.3/Recharts.min.js"></script>
    
    <!-- 4. 工具 -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // 錯誤過濾
        const _error = console.error;
        console.error = (...args) => {
            if (typeof args[0] === 'string' && args[0].includes('ResizeObserver')) return;
            _error(...args);
        };
    </script>
</head>
<body class="bg-slate-50 text-slate-900">

    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // LEVEL 0: 第三方庫解構
        // ==========================================
        const { useState, useMemo, useEffect, useRef } = React;
        const { 
            LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, 
            AreaChart, Area, PieChart, Pie, Cell 
        } = window.Recharts || {};

        // ==========================================
        // LEVEL 1: 全域常數 (GLOBAL CONSTANTS)
        // ==========================================

        const COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1', '#64748b', '#06b6d4'];

        const TYPE_MAP = { 
            "Buy": "買入", 
            "Sell": "賣出", 
            "Dividend Reinvest": "股息再投入", 
            "Dividend": "股息", 
            "Sell All": "全部賣出" 
        };

        const CURRENT_PRICES = {
            "VT": 141.22, "VTI": 335.33, "VXUS": 75.87,
            "AVDV": 93.91, "AVUV": 105.04, "AVES": 58.34,
            "QMOM": 65.95, "IMOM": 38.49, "QVAL": 49.77, "IVAL": 31.52,
            "006208.TW": 145.50, "0050.TW": 208.00
        };

        const HISTORICAL_PRICES = {
            "VT": [
                {d:"2022-01-31",p:103.00}, {d:"2022-02-28",p:101.50}, {d:"2022-03-31",p:102.00}, {d:"2022-06-30",p:88.00}, {d:"2022-09-30",p:82.00}, {d:"2022-12-31",p:87.08},
                {d:"2023-03-31",p:91.00}, {d:"2023-06-30",p:96.00}, {d:"2023-09-30",p:95.00}, {d:"2023-12-31",p:102.44},
                {d:"2024-01-31",p:103.50}, {d:"2024-02-29",p:106.80}, {d:"2024-03-31",p:109.50}, {d:"2024-04-30",p:103.00}, {d:"2024-05-31",p:109.80}, 
                {d:"2024-06-30",p:111.50}, {d:"2024-07-31",p:113.20}, {d:"2024-08-31",p:115.00}, {d:"2024-09-30",p:117.50}, {d:"2024-10-31",p:116.00}, 
                {d:"2024-11-30",p:120.50}, {d:"2024-12-31",p:122.00}, 
                {d:"2025-01-31",p:121.00}, {d:"2025-02-28",p:125.00}, {d:"2025-03-31",p:135.00}, {d:"2025-04-30",p:133.00}, {d:"2025-05-31",p:138.00}, 
                {d:"2025-06-30",p:146.00}, {d:"2025-07-31",p:145.00}, {d:"2025-08-31",p:148.00}, {d:"2025-09-30",p:156.00}, {d:"2025-10-31",p:154.00}, 
                {d:"2025-11-30",p:140.00}, {d:"2025-12-15",p:141.22}
            ],
            "VTI": [
                {d:"2022-01-31",p:220.00}, {d:"2022-06-30",p:190.00}, {d:"2022-12-31",p:191.19},
                {d:"2023-06-30",p:220.28}, {d:"2023-12-31",p:237.22},
                {d:"2024-01-31",p:240.00}, {d:"2024-02-29",p:250.50}, {d:"2024-03-31",p:258.00}, {d:"2024-04-30",p:246.00}, {d:"2024-05-31",p:259.00},
                {d:"2024-06-30",p:265.00}, {d:"2024-07-31",p:268.00}, {d:"2024-08-31",p:275.00}, {d:"2024-09-30",p:280.00}, {d:"2024-10-31",p:276.00},
                {d:"2024-11-30",p:290.00}, {d:"2024-12-31",p:295.00}, 
                {d:"2025-01-31",p:300.00}, {d:"2025-02-28",p:305.00}, {d:"2025-03-31",p:310.00}, {d:"2025-04-30",p:300.00}, {d:"2025-05-31",p:315.00}, 
                {d:"2025-06-30",p:320.00}, {d:"2025-07-31",p:325.00}, {d:"2025-08-31",p:328.00}, {d:"2025-09-30",p:330.00}, {d:"2025-10-31",p:328.00},
                {d:"2025-11-30",p:336.00}, {d:"2025-12-15",p:335.33}
            ],
            "VXUS": [
                {d:"2022-01-31",p:60.00}, {d:"2022-12-31",p:54.00}, {d:"2023-12-31",p:58.00},
                {d:"2024-01-31",p:56.00}, {d:"2024-02-29",p:58.00}, {d:"2024-03-31",p:60.00}, {d:"2024-04-30",p:57.00}, {d:"2024-05-31",p:59.00},
                {d:"2024-06-30",p:60.00}, {d:"2024-07-31",p:61.00}, {d:"2024-08-31",p:62.00}, {d:"2024-09-30",p:63.00}, {d:"2024-10-31",p:62.00},
                {d:"2024-11-30",p:64.00}, {d:"2024-12-31",p:65.00},
                {d:"2025-01-31",p:68.00}, {d:"2025-02-28",p:70.00}, {d:"2025-03-31",p:73.00}, {d:"2025-04-30",p:72.00}, {d:"2025-05-31",p:74.00},
                {d:"2025-06-30",p:78.00}, {d:"2025-07-31",p:77.00}, {d:"2025-08-31",p:76.00}, {d:"2025-09-30",p:79.00}, {d:"2025-10-31",p:78.00},
                {d:"2025-11-30",p:75.50}, {d:"2025-12-15",p:75.87}
            ],
            "AVUV": [
                {d:"2022-01-31",p:78.00}, {d:"2022-12-31",p:75.00},
                {d:"2023-12-31",p:85.00},
                {d:"2024-01-31",p:85.00}, {d:"2024-02-29",p:88.60}, {d:"2024-03-31",p:92.00}, {d:"2024-04-30",p:86.00}, {d:"2024-05-31",p:90.00},
                {d:"2024-06-30",p:91.00}, {d:"2024-07-31",p:94.00}, {d:"2024-08-31",p:93.00}, {d:"2024-09-30",p:95.00}, {d:"2024-10-31",p:93.50},
                {d:"2024-11-30",p:98.00}, {d:"2024-12-31",p:100.00}, 
                {d:"2025-01-31",p:102.00}, {d:"2025-06-30",p:104.00}, {d:"2025-11-30",p:106.00}, {d:"2025-12-15",p:105.04}
            ],
            "AVDV": [
                {d:"2022-01-31",p:65.00}, {d:"2022-12-31",p:58.00},
                {d:"2023-12-31",p:62.00},
                {d:"2024-01-31",p:60.00}, {d:"2024-02-29",p:62.00}, {d:"2024-03-31",p:63.00}, {d:"2024-04-30",p:60.00}, {d:"2024-05-31",p:62.00},
                {d:"2024-06-30",p:64.00}, {d:"2024-09-30",p:68.00}, {d:"2024-12-31",p:71.00}, 
                {d:"2025-03-31",p:75.00}, {d:"2025-06-30",p:80.00}, {d:"2025-09-30",p:85.00}, {d:"2025-11-30",p:92.22}, {d:"2025-12-15",p:93.91}
            ],
            "AVES": [
                {d:"2022-01-31",p:50.00}, {d:"2022-12-31",p:42.00},
                {d:"2023-12-31",p:46.00},
                {d:"2024-06-30",p:49.00}, {d:"2024-12-31",p:52.00},
                {d:"2025-06-30",p:55.00}, {d:"2025-11-30",p:58.00}, {d:"2025-12-15",p:58.34}
            ],
            "QMOM": [
                {d:"2022-01-31",p:55.00}, {d:"2022-12-31",p:50.00},
                {d:"2023-12-31",p:55.00},
                {d:"2024-06-30",p:60.00}, {d:"2024-12-31",p:63.00},
                {d:"2025-06-30",p:64.50}, {d:"2025-11-30",p:65.50}, {d:"2025-12-15",p:65.95}
            ],
            "IMOM": [
                {d:"2022-01-31",p:32.00}, {d:"2022-12-31",p:28.00},
                {d:"2023-12-31",p:30.00},
                {d:"2024-06-30",p:32.00}, {d:"2024-12-31",p:34.00},
                {d:"2025-06-30",p:36.00}, {d:"2025-11-30",p:38.00}, {d:"2025-12-15",p:38.49}
            ],
            "QVAL": [
                {d:"2022-01-31",p:40.00}, {d:"2022-12-31",p:35.00},
                {d:"2023-12-31",p:38.00},
                {d:"2024-06-30",p:42.00}, {d:"2024-12-31",p:45.00},
                {d:"2025-06-30",p:47.00}, {d:"2025-11-30",p:48.59}, {d:"2025-12-15",p:49.77}
            ],
            "IVAL": [
                {d:"2022-01-31",p:28.00}, {d:"2022-12-31",p:22.00},
                {d:"2023-12-31",p:24.00},
                {d:"2024-06-30",p:26.00}, {d:"2024-12-31",p:28.00},
                {d:"2025-06-30",p:30.00}, {d:"2025-11-30",p:31.20}, {d:"2025-12-15",p:31.52}
            ],
            "006208.TW": [
                {d:"2022-12-31",p:65.05},
                {d:"2023-12-31",p:90.00},
                {d:"2024-06-30",p:105.00}, {d:"2024-12-31",p:113.45},
                {d:"2025-06-30",p:125.00}, {d:"2025-11-30",p:142.85}, {d:"2025-12-15",p:145.50}
            ],
            "0050.TW": [
                {d:"2022-12-31",p:110.00},
                {d:"2023-12-31",p:130.00},
                {d:"2024-06-30",p:160.00}, {d:"2024-12-31",p:175.00},
                {d:"2025-06-30",p:190.00}, {d:"2025-11-30",p:200.00}, {d:"2025-12-15",p:208.00}
            ]
        };

        const DEFAULT_CSV_DATA = `Id,Symbol,Name,Display Symbol,Exchange,Portfolio,Currency,Shares Owned,Cost Per Share,Commission,Transaction Date,Transaction Time,Purchase Exchange Rate,Type,Accounting,Accounting Execution Ids,Notes

"1","IMOM","Alpha Architect International Q",,"NGM","Firstrade 帳戶","USD",,,,,,,,,,
"2","IMOM","Alpha Architect International Q",,"NGM","Firstrade 帳戶","USD","143","27.97","0","2024-02-16 GMT+0800","21:47:00",,"Buy",,,
"3","IMOM","Alpha Architect International Q",,"NGM","Firstrade 帳戶","USD","13","28.3","0","2024-11-08 GMT+0800","23:43:00","0","Buy",,,
"4","IMOM","Alpha Architect International Q",,"NGM","Firstrade 帳戶","USD","2","30.25","0","2024-11-12 GMT+0800","23:40:00","0","Buy",,,
"5","IMOM","Alpha Architect International Q",,"NGM","Firstrade 帳戶","USD","4.98839","45.50","0","2025-12-12 GMT+0800","00:42:00","0","Dividend Reinvest",,,

"6","AVUV","Avantis U.S. Small Cap Value ET",,"PCX","Firstrade 帳戶","USD",,,,,,,,,,
"7","AVUV","Avantis U.S. Small Cap Value ET",,"PCX","Firstrade 帳戶","USD","41","88.6","0","2024-02-16 GMT+0800","22:28:00",,"Buy",,,
"8","AVUV","Avantis U.S. Small Cap Value ET",,"PCX","Firstrade 帳戶","USD","0.09574","91.915","0","2024-03-25 GMT+0800","09:44:00","0","Dividend Reinvest",,,
"9","AVUV","Avantis U.S. Small Cap Value ET",,"PCX","Firstrade 帳戶","USD","0.13963","88.234","0","2024-06-26 GMT+0800","22:46:00","0","Dividend Reinvest",,,
"10","AVUV","Avantis U.S. Small Cap Value ET",,"PCX","Firstrade 帳戶","USD","0.1175","94.9781","0","2024-09-25 GMT+0800","00:15:00","0","Dividend Reinvest",,,
"11","AVUV","Avantis U.S. Small Cap Value ET",,"PCX","Firstrade 帳戶","USD","2","103.68","0","2024-11-07 GMT+0800","23:37:00","0","Sell","Weighted Average",,
"12","AVUV","Avantis U.S. Small Cap Value ET",,"PCX","Firstrade 帳戶","USD","0.12412","105.44","0","2024-12-19 GMT+0800","00:39:00","0","Dividend Reinvest",,,
"13","AVUV","Avantis U.S. Small Cap Value ET",,"PCX","Firstrade 帳戶","USD","0.10587","118.20","0","2025-12-12 GMT+0800","00:41:00","0","Dividend Reinvest",,,

"14","QVAL","Alpha Architect U.S. Quantitati",,"NGM","Firstrade 帳戶","USD",,,,,,,,,,
"15","QVAL","Alpha Architect U.S. Quantitati",,"NGM","Firstrade 帳戶","USD","85","41.16","0","2024-02-16 GMT+0800","22:36:00",,"Buy",,,
"16","QVAL","Alpha Architect U.S. Quantitati",,"NGM","Firstrade 帳戶","USD","1","40.64","0","2024-02-20 GMT+0800","22:51:00",,"Buy",,,
"17","QVAL","Alpha Architect U.S. Quantitati",,"NGM","Firstrade 帳戶","USD","0.19534","42.9","0","2024-03-15 GMT+0800","00:27:00","0","Dividend Reinvest",,,
"18","QVAL","Alpha Architect U.S. Quantitati",,"NGM","Firstrade 帳戶","USD","0.37915","43.07","0","2024-06-21 GMT+0800","22:41:00","0","Dividend Reinvest",,,
"19","QVAL","Alpha Architect U.S. Quantitati",,"NGM","Firstrade 帳戶","USD","0.20276","44.24","0","2024-09-13 GMT+0800","00:13:00","0","Dividend Reinvest",,,
"20","QVAL","Alpha Architect U.S. Quantitati",,"NGM","Firstrade 帳戶","USD","0.2861","46.80","0","2024-12-31 GMT+0800","00:47:00","0","Dividend Reinvest",,,
"21","QVAL","Alpha Architect U.S. Quantitati",,"NGM","Firstrade 帳戶","USD","0.14458","52.40","0","2025-12-12 GMT+0800","00:48:00","0","Dividend Reinvest",,,"P"

"22","VTI","Vanguard Total Stock Market ETF",,"PCX","Firstrade 帳戶","USD",,,,,,,,,,
"23","VTI","Vanguard Total Stock Market ETF",,"PCX","Firstrade 帳戶","USD","48","249.67","0","2024-02-16 GMT+0800","22:44:00",,"Buy",,,
"24","VTI","Vanguard Total Stock Market ETF",,"PCX","Firstrade 帳戶","USD","0.11819","258.8275","0","2024-03-27 GMT+0800","09:46:00","0","Dividend Reinvest",,,
"25","VTI","Vanguard Total Stock Market ETF",,"PCX","Firstrade 帳戶","USD","0.11979","267.6454","0","2024-07-02 GMT+0800","10:16:00","0","Dividend Reinvest",,,
"26","VTI","Vanguard Total Stock Market ETF",,"PCX","Firstrade 帳戶","USD","0.10458","281.1376","0","2024-10-01 GMT+0800","23:32:00","0","Dividend Reinvest",,,
"27","VTI","Vanguard Total Stock Market ETF",,"PCX","Firstrade 帳戶","USD","2","295.01","0","2024-11-07 GMT+0800","23:33:00","0","Sell","Weighted Average",,
"28","VTI","Vanguard Total Stock Market ETF",,"PCX","Firstrade 帳戶","USD","0.10361","305.66","0","2024-12-26 GMT+0800","00:50:00","0","Dividend Reinvest",,,
"29","VTI","Vanguard Total Stock Market ETF",,"PCX","Firstrade 帳戶","USD","0.11889","315.50","0","2025-12-12 GMT+0800","00:50:00","0","Dividend Reinvest",,,

"30","QMOM","Alpha Architect U.S. Quantitati",,"NGM","Firstrade 帳戶","USD",,,,,,,,,,
"31","QMOM","Alpha Architect U.S. Quantitati",,"NGM","Firstrade 帳戶","USD","88","54.96","0","2024-02-16 GMT+0800","22:46:00",,"Buy",,,
"32","QMOM","Alpha Architect U.S. Quantitati",,"NGM","Firstrade 帳戶","USD","1","54.2","0","2024-02-20 GMT+0800","22:50:00",,"Buy",,,
"33","QMOM","Alpha Architect U.S. Quantitati",,"NGM","Firstrade 帳戶","USD","1","53.49","0","2024-02-21 GMT+0800","22:52:00",,"Buy",,,
"34","QMOM","Alpha Architect U.S. Quantitati",,"NGM","Firstrade 帳戶","USD","8","68.63","0","2024-11-07 GMT+0800","23:39:00","0","Sell","Weighted Average",,
"35","QMOM","Alpha Architect U.S. Quantitati",,"NGM","Firstrade 帳戶","USD","0.80332","68.80","0","2025-12-12 GMT+0800","00:46:00","0","Dividend Reinvest",,,

"36","AVES","Avantis Emerging Markets Value ",,"PCX","Firstrade 帳戶","USD",,,,,,,,,,
"37","AVES","Avantis Emerging Markets Value ",,"PCX","Firstrade 帳戶","USD","38","46.68","0","2024-02-20 GMT+0800","22:46:00",,"Buy",,,
"38","AVES","Avantis Emerging Markets Value ",,"PCX","Firstrade 帳戶","USD","1","46.26","0","2024-04-16 GMT+0800","09:48:00","0","Buy",,,
"39","AVES","Avantis Emerging Markets Value ",,"PCX","Firstrade 帳戶","USD","0.26866","48.5","0","2024-06-26 GMT+0800","22:48:00","0","Dividend Reinvest",,,
"40","AVES","Avantis Emerging Markets Value ",,"PCX","Firstrade 帳戶","USD","1","49.995","0","2024-11-08 GMT+0800","23:44:00","0","Buy",,,
"41","AVES","Avantis Emerging Markets Value ",,"PCX","Firstrade 帳戶","USD","0.84878","58.90","0","2025-12-12 GMT+0800","00:37:00","0","Dividend Reinvest",,,

"42","IVAL","Alpha Architect International Q",,"NGM","Firstrade 帳戶","USD",,,,,,,,,,
"43","IVAL","Alpha Architect International Q",,"NGM","Firstrade 帳戶","USD","86","25.77","0","2024-02-20 GMT+0800","22:47:00",,"Buy",,,
"44","IVAL","Alpha Architect International Q",,"NGM","Firstrade 帳戶","USD","0.33739","26.4385","0","2024-03-15 GMT+0800","00:24:00","0","Dividend Reinvest",,,
"45","IVAL","Alpha Architect International Q",,"NGM","Firstrade 帳戶","USD","1.06738","24.8083","0","2024-06-21 GMT+0800","22:37:00","0","Dividend Reinvest",,,
"46","IVAL","Alpha Architect International Q",,"NGM","Firstrade 帳戶","USD","0.10463","25.041","0","2024-09-13 GMT+0800","00:11:00","0","Dividend Reinvest",,,
"47","IVAL","Alpha Architect International Q",,"NGM","Firstrade 帳戶","USD","13","24.67","0","2024-11-08 GMT+0800","23:42:00","0","Buy",,,
"48","IVAL","Alpha Architect International Q",,"NGM","Firstrade 帳戶","USD","0.69103","26.09","0","2024-12-31 GMT+0800","00:44:00","0","Dividend Reinvest",,,
"49","IVAL","Alpha Architect International Q",,"NGM","Firstrade 帳戶","USD","0.18288","36.20","0","2025-12-12 GMT+0800","00:45:00","0","Dividend Reinvest",,,

"50","VXUS","Vanguard Total International St",,"NGM","Firstrade 帳戶","USD",,,,,,,,,,
"51","VXUS","Vanguard Total International St",,"NGM","Firstrade 帳戶","USD","176","58.25","0","2024-02-20 GMT+0800","22:48:00",,"Buy",,,
"52","VXUS","Vanguard Total International St",,"NGM","Firstrade 帳戶","USD","0.46209","59.5992","0","2024-03-20 GMT+0800","00:21:00","0","Dividend Reinvest",,,
"53","VXUS","Vanguard Total International St",,"NGM","Firstrade 帳戶","USD","0.98989","60.3299","0","2024-06-25 GMT+0800","22:44:00","0","Dividend Reinvest",,,
"54","VXUS","Vanguard Total International St",,"NGM","Firstrade 帳戶","USD","0.52951","63.87","0","2024-09-24 GMT+0800","00:14:00","0","Dividend Reinvest",,,
"55","VXUS","Vanguard Total International St",,"NGM","Firstrade 帳戶","USD","9","62.1899","0","2024-11-08 GMT+0800","23:43:00","0","Buy",,,
"56","VXUS","Vanguard Total International St",,"NGM","Firstrade 帳戶","USD","2.22069","65.22","0","2024-12-24 GMT+0800","00:52:00","0","Dividend Reinvest",,,
"57","VXUS","Vanguard Total International St",,"NGM","Firstrade 帳戶","USD","0.39587","74.50","0","2025-12-12 GMT+0800","00:52:00","0","Dividend Reinvest",,,

"58","AVDV","Avantis International Small Cap",,"PCX","Firstrade 帳戶","USD",,,,,,,,,,
"59","AVDV","Avantis International Small Cap",,"PCX","Firstrade 帳戶","USD","36","61.5","0","2024-02-20 GMT+0800","22:49:00",,"Buy",,,
"60","AVDV","Avantis International Small Cap",,"PCX","Firstrade 帳戶","USD","0.46133","64.6604","0","2024-06-26 GMT+0800","22:49:00","0","Dividend Reinvest",,,
"61","AVDV","Avantis International Small Cap",,"PCX","Firstrade 帳戶","USD","0.64585","79.80","0","2025-12-12 GMT+0800","00:35:00","0","Dividend Reinvest",,,

"62","USD=CASH",,,,"Firstrade 帳戶","USD",,,,,,,,,,
"63","USD=CASH",,,,"Firstrade 帳戶","USD","590.02","0","0","2024-11-07 GMT+0800","23:33:00",,"Buy",,,"賣出 VTI - Vanguard Total Stock Market ETF"
"64","USD=CASH",,,,"Firstrade 帳戶","USD","207.36","0","0","2024-11-07 GMT+0800","23:37:00",,"Buy",,,"賣出 AVUV - Avantis U.S. Small Cap Value ET"
"65","USD=CASH",,,,"Firstrade 帳戶","USD","549.04","0","0","2024-11-07 GMT+0800","23:39:00",,"Buy",,,"賣出 QMOM - Alpha Architect U.S. Quantitati"
"66","USD=CASH",,,,"Firstrade 帳戶","USD","320.71","0","0","2024-11-08 GMT+0800","23:42:00",,"Sell",,,"買進 IVAL - Alpha Architect International Q"
"67","USD=CASH",,,,"Firstrade 帳戶","USD","367.9","0","0","2024-11-08 GMT+0800","23:43:00",,"Sell",,,"買進 IMOM - Alpha Architect International Q"
"68","USD=CASH",,,,"Firstrade 帳戶","USD","559.7091","0","0","2024-11-08 GMT+0800","23:43:00",,"Sell",,,"買進 VXUS - Vanguard Total International St"
"69","USD=CASH",,,,"Firstrade 帳戶","USD","49.995","0","0","2024-11-08 GMT+0800","23:44:00",,"Sell",,,"買進 AVES - Avantis Emerging Markets Value "
"70","USD=CASH",,,,"Firstrade 帳戶","USD","56.5","0","0","2024-11-12 GMT+0800","23:40:00",,"Sell",,,"買進 IMOM - Alpha Architect International Q"

"71","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD",,,,,,,,,,
"72","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","10.45569","102.34","3.21","2022-02-22 GMT+0800","23:49:00",,"Buy",,,
"73","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","5.48145","96.69","1.59","2022-03-07 GMT+0800","23:51:00",,"Buy",,,
"74","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","5.07409","98.54","0.9","2022-04-18 GMT+0800","23:56:00",,"Buy",,,
"75","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","5.55696","89.98","0.9","2022-05-16 GMT+0800","23:58:00",,"Buy",,,
"76","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","5.91647","84.51","0.9","2022-06-16 GMT+0800","00:03:00",,"Buy",,,
"77","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","5.7844","86.43","0.89","2022-07-18 GMT+0800","00:05:00",,"Buy",,,
"78","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","5.31278","94.11","0.9","2022-08-16 GMT+0800","00:06:00",,"Buy",,,
"79","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","5.78908","85.5","0.89","2022-09-16 GMT+0800","00:08:00",,"Buy",,,
"80","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","6.21969","80.39","0.9","2022-10-17 GMT+0800","00:09:00",,"Buy",,,
"81","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","5.64399","88.59","0.9","2022-11-16 GMT+0800","00:11:00",,"Buy",,,
"82","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","5.74167","87.08","0.9","2022-12-16 GMT+0800","00:12:00",,"Buy",,,
"83","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","5.48127","91.22","0.9","2023-01-17 GMT+0800","00:13:00",,"Buy",,,
"84","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","5.40483","92.51","0.9","2023-02-16 GMT+0800","00:14:00",,"Buy",,,
"85","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","5.6942","87.81","0.9","2023-03-20 GMT+0800","00:17:00",,"Buy",,,
"86","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","5.37231","93.07","0.9","2023-04-17 GMT+0800","00:18:00",,"Buy",,,
"87","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","5.38759","92.81","0.9","2023-05-16 GMT+0800","00:19:00",,"Buy",,,
"88","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","5.27594","94.77","0.9","2023-06-23 GMT+0800","00:20:00",,"Buy",,,
"89","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","5.06443","98.73","0.9","2023-07-17 GMT+0800","00:21:00",,"Buy",,,
"90","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","5.19536","96.24","0.9","2023-08-16 GMT+0800","00:22:00",,"Buy",,,
"91","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","6.37336","97.28","1","2023-09-11 GMT+0800","00:23:00",,"Buy",,,
"92","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","5.44566","89.98","0.88","2023-10-26 GMT+0800","00:25:00",,"Buy",,,
"93","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","4.76262","98.69","0.84","2023-11-29 GMT+0800","00:26:00",,"Buy",,,
"94","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","4.68571","102.44","0.86","2023-12-26 GMT+0800","00:27:00",,"Buy",,,
"95","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","5.31392","101.62","0.97","2024-01-19 GMT+0800","00:28:00",,"Buy",,,
"96","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","4.464","107.53","0.86","2024-02-26 GMT+0800","00:30:00",,"Buy",,,
"97","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","4.32593","108.65","0.84","2024-03-11 GMT+0800","13:03:00","0","Buy",,,
"98","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","4.65738","107.36","0.9","2024-04-26 GMT+0800","18:13:00","0","Buy",,,
"99","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","4.18753","109.85","0.82","2024-05-09 GMT+0800","22:50:00","0","Buy",,,
"100","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","4.08626","112.54","0.82","2024-06-06 GMT+0800","20:50:00","0","Buy",,,
"101","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","4.90303","106.06","0.93","2024-08-05 GMT+0800","14:05:00","0","Buy",,,
"102","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","4.017","117","0.84","2024-08-29 GMT+0800","21:50:00","0","Buy",,,
"103","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","3.91134","120.15","0.46","2024-09-26 GMT+0800","00:17:00","0","Buy",,,
"104","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","4.35803","119.32","0.52","2024-10-28 GMT+0800","19:47:00","0","Buy",,,
"105","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","3.79383","121.25","0.46","2024-11-29 GMT+0800","11:12:00","0","Buy",,,
"106","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","3.84909","119.51","0.46","2024-12-26 GMT+0800","23:02:00","0","Buy",,,
"107","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","4.65002","120.43","0.56","2025-01-21 GMT+0800","15:08:00","0","Buy",,,
"108","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","3.7634","122.23","0.46","2025-02-06 GMT+0800","15:10:00","0","Buy",,,
"109","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","3.85293","119.39","0.46","2025-03-06 GMT+0800","15:11:00","0","Buy",,,
"110","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","4.8581","102.92","0.5","2025-04-09 GMT+0800","15:12:00","0","Buy",,,
"111","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","4.12713","121.15","0.5","2025-05-23 GMT+0800","15:13:00","0","Buy",,,
"112","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","3.98947","125.33","0.5","2025-06-06 GMT+0800","15:14:00","0","Buy",,,
"113","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","4.71553","129.36","0.61","2025-07-03 GMT+0800","15:15:00","0","Buy",,,
"114","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","3.86101","129.5","0.03","2025-08-04 GMT+0800","15:16:00","0","Buy",,,
"115","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","3.63259","134.89","0.01","2025-09-08 GMT+0800","15:17:00","0","Buy",,,
"116","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","0.50312","139.13","0.01","2025-10-03 GMT+0800","18:12:00","0","Dividend Reinvest",,,
"117","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","3.53383","138.66","0.01","2025-10-16 GMT+0800","18:13:00","0","Buy",,,
"118","VT","Vanguard Total World Stock Inde",,"PCX","美股VT三人組","USD","3.40232","141.08","0.01","2025-12-12 GMT+0800","18:14:00","0","Buy",,,

"119","USD=CASH",,,,"美股VT三人組","USD",,,,,,,,,,

"120","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD",,,,,,,,,,
"121","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","2.12285","89.5","0.34","2022-12-16 GMT+0800","01:48:00",,"Buy",,,
"122","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","2.08287","91.22","0.34","2023-01-17 GMT+0800","01:50:00",,"Buy",,,
"123","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","2.27003","92.51","0.37","2023-02-16 GMT+0800","01:52:00",,"Buy",,,
"124","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","2.30024","86.95","0.36","2023-03-16 GMT+0800","01:53:00",,"Buy",,,
"125","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","2.14892","93.07","0.36","2023-04-17 GMT+0800","01:54:00",,"Buy",,,
"126","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","2.04729","92.81","0.34","2023-05-16 GMT+0800","01:56:00",,"Buy",,,
"127","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","1.93188","98.35","0.34","2023-06-16 GMT+0800","01:57:00",,"Buy",,,
"128","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","1.91239","99.35","0.34","2023-07-24 GMT+0800","01:58:00",,"Buy",,,
"129","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","1.98812","95.57","0.34","2023-08-23 GMT+0800","01:59:00",,"Buy",,,
"130","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","2.05592","97.28","0.36","2023-09-11 GMT+0800","02:00:00",,"Buy",,,
"131","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","2.11159","89.98","0.34","2023-10-26 GMT+0800","02:02:00",,"Buy",,,
"132","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","1.92532","98.69","0.34","2023-11-29 GMT+0800","02:03:00",,"Buy",,,
"133","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","1.85476","102.44","0.34","2023-12-26 GMT+0800","02:04:00",,"Buy",,,
"134","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","1.86972","101.62","0.34","2024-01-19 GMT+0800","02:05:00",,"Buy",,,
"135","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","1.88756","105.96","0.36","2024-02-20 GMT+0800","02:06:00",,"Buy",,,
"136","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","1.82282","109.72","0.36","2024-03-25 GMT+0800","20:48:00","0","Buy",,,
"137","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","1.73659","109.41","0.34","2024-04-03 GMT+0800","09:53:00","0","Buy",,,
"138","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","1.72963","109.85","0.34","2024-05-09 GMT+0800","22:48:00","0","Buy",,,
"139","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","1.68781","112.54","0.34","2024-06-06 GMT+0800","20:52:00","0","Buy",,,
"140","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","1.88575","106.06","0.36","2024-08-05 GMT+0800","13:56:00","0","Buy",,,
"141","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","1.53843","117","0.32","2024-08-29 GMT+0800","21:47:00","0","Buy",,,
"142","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","1.58118","120.15","0.18","2024-09-26 GMT+0800","00:18:00","0","Buy",,,
"143","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","1.67617","119.32","0.2","2024-10-28 GMT+0800","19:50:00","0","Buy",,,
"144","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","1.48455","121.25","0.18","2024-11-29 GMT+0800","11:14:00","0","Buy",,,
"145","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","1.58985","119.51","0.19","2024-12-26 GMT+0800","23:04:00","0","Buy",,,
"146","VT","Vanguard Total World Stock Inde",,"PCX","舒雅VT雙人組","USD","0","119.37","0","2025-01-07 GMT+0800","00:12:00","0","Sell All","FIFO",,

"147","USD=CASH",,,,"舒雅VT雙人組","USD",,,,,,,,,,

"148","006208.TW","Fubon Asset Management Co Ltd F",,"TAI","飛台股","TWD",,,,,,,,,,
"149","006208.TW","Fubon Asset Management Co Ltd F",,"TAI","飛台股","TWD","78","86.59","1","2024-03-06 GMT+0800","20:54:00",,"Buy",,,
"150","006208.TW","Fubon Asset Management Co Ltd F",,"TAI","飛台股","TWD","79","88.91","1","2024-04-19 GMT+0800","09:51:00","0","Buy",,,
"151","006208.TW","Fubon Asset Management Co Ltd F",,"TAI","飛台股","TWD","325","94.32","4","2024-05-09 GMT+0800","21:42:00","0","Buy",,,
"152","006208.TW","Fubon Asset Management Co Ltd F",,"TAI","飛台股","TWD","74","101.99","1","2024-06-06 GMT+0800","20:24:00","0","Buy",,,
"153","006208.TW","Fubon Asset Management Co Ltd F",,"TAI","飛台股","TWD","85","109.67","1","2024-07-03 GMT+0800","01:37:00","0","Buy",,,
"154","006208.TW","Fubon Asset Management Co Ltd F",,"TAI","飛台股","TWD","76","95.99","1","2024-08-05 GMT+0800","10:21:00","0","Buy",,,
"155","006208.TW","Fubon Asset Management Co Ltd F",,"TAI","飛台股","TWD","502","0","0","2024-08-09 GMT+0800","15:17:00","0","Dividend","FIFO",,
"156","006208.TW","Fubon Asset Management Co Ltd F",,"TAI","飛台股","TWD","0","145.50","185","2025-12-12 GMT+0800","12:20:00","0","Sell All","FIFO",,

"157","TWD=CASH","TWD",,,"飛台股","TWD",,,,,,,,,,
"158","TWD=CASH","TWD",,,"飛台股","TWD","502","0","0","2024-08-09 GMT+0800","15:17:00",,"Buy",,,"從 006208.TW 來的股利 - Fubon Asset Management Co Ltd F"
"159","TWD=CASH","TWD",,,"飛台股","TWD","76752.87108","0","0","2024-08-16 GMT+0800","12:20:00",,"Buy",,,"賣出 006208.TW - Fubon Asset Management Co Ltd F"
"160","TWD=CASH","TWD",,,"飛台股","TWD","77254.87","0","0","2024-08-17 GMT+0800","21:37:00","0","Sell",,,

"161","0050.TW","Yuanta Securities Inv Trust Co ",,"TAI","寶的台股","TWD",,,,,,,,,,
"162","0050.TW","Yuanta Securities Inv Trust Co ",,"TAI","寶的台股","TWD","48","155.52","1","2024-03-13 GMT+0800","20:14:00","0","Buy",,,
"163","0050.TW","Yuanta Securities Inv Trust Co ",,"TAI","寶的台股","TWD","47","151.91","1","2024-04-23 GMT+0800","23:22:00","0","Buy",,,
"164","0050.TW","Yuanta Securities Inv Trust Co ",,"TAI","寶的台股","TWD","180","160.96","4","2024-05-09 GMT+0800","21:40:00","0","Buy",,,
"165","0050.TW","Yuanta Securities Inv Trust Co ",,"TAI","寶的台股","TWD","46","173.63","1","2024-06-11 GMT+0800","20:22:00","0","Buy",,,
"166","0050.TW","Yuanta Securities Inv Trust Co ",,"TAI","寶的台股","TWD","49","197.18","1","2024-07-15 GMT+0800","20:14:00","0","Buy",,,
"167","0050.TW","Yuanta Securities Inv Trust Co ",,"TAI","寶的台股","TWD","44","162.89","1","2024-08-05 GMT+0800","10:19:00","0","Buy",,,
"168","0050.TW","Yuanta Securities Inv Trust Co ",,"TAI","寶的台股","TWD","370","0","0","2024-08-09 GMT+0800","13:30:00","0","Dividend","FIFO",,
"169","0050.TW","Yuanta Securities Inv Trust Co ",,"TAI","寶的台股","TWD","414","208.00","182","2025-12-12 GMT+0800","13:31:00","0","Sell All","FIFO",,

"170","TWD=CASH","TWD",,,"寶的台股","TWD",,,,,,,,,,
`;

        // ==========================================
        // LEVEL 2: 核心計算函式 (Defined BEFORE Components)
        // ==========================================

        const parseCSV = (csvText) => {
            if (!csvText) return [];
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            const data = [];
            const re = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;
                const values = line.split(re).map(val => val.replace(/^"|"$/g, '').trim());
                const entry = {};
                headers.forEach((header, index) => entry[header] = values[index]);
                if (entry['Transaction Date'] && entry['Symbol']) data.push(entry);
            }
            return data;
        };

        const calculateXIRR=(t,c,l)=>{const f=[...t];f.push({amount:c,date:l>new Date()?l:new Date()});if(f.length<2)return 0;const d=f.sort((a,b)=>a.date-b.date),t0=d[0].date,x=r=>d.reduce((s,x)=>s+x.amount/Math.pow(1+r,(x.date-t0)/31536000000),0),dx=r=>d.reduce((s,x)=>s-((x.date-t0)/31536000000)*x.amount/Math.pow(1+r,((x.date-t0)/31536000000)+1),0);let r=0.1;for(let i=0;i<50;i++){const v=x(r),d=dx(r);if(Math.abs(d)<1e-10)break;const n=r-v/d;if(Math.abs(n-r)<1e-6)return n;r=n}return isFinite(r)?r:0};
        const calculateSharpe=(c,r=0.02)=>{if(c.length<5)return 0;const R=[];for(let i=1;i<c.length;i++){const p=c[i-1].value,n=c[i].value;if(p>0)R.push((n-p)/p)}if(R.length===0)return 0;const m=R.reduce((a,b)=>a+b,0)/R.length,s=Math.sqrt(R.reduce((a,b)=>a+Math.pow(b-m,2),0)/R.length);return s===0?0:((m*52)-r)/(s*Math.sqrt(52))};
        const calculateMaxDrawdown=(c)=>{let m=0,p=-Infinity;for(let x of c){if(x.value>p)p=x.value;const d=(p-x.value)/p;if(d>m)m=d}return m*100};
        const calculateVolatility=(c)=>{if(c.length<2)return 0;const R=[];for(let i=1;i<c.length;i++){const p=c[i-1].value,n=c[i].value;if(p>0)R.push((n-p)/p)}const m=R.reduce((a,b)=>a+b,0)/R.length,v=R.reduce((a,b)=>a+Math.pow(b-m,2),0)/R.length;return Math.sqrt(v)*Math.sqrt(52)*100};

        const getInterpolatedPrice = (symbol, targetDateStr) => {
            const targetTime = new Date(targetDateStr).getTime();
            let benchmarks = HISTORICAL_PRICES[symbol] || [];
            if (benchmarks.length === 0) return 0;
            let prev = null, next = null;
            for (let i = 0; i < benchmarks.length; i++) {
                const ptTime = new Date(benchmarks[i].d).getTime();
                if (ptTime <= targetTime) {
                     prev = benchmarks[i];
                } else {
                     next = benchmarks[i];
                     break;
                }
            }
            if (!prev && next) return next.p;
            if (prev && !next) return prev.p;
            if (!prev && !next) return 0;
            const t1 = new Date(prev.d).getTime(), t2 = new Date(next.d).getTime();
            if (t2 === t1) return prev.p;
            const ratio = (targetTime - t1) / (t2 - t1);
            return prev.p + (next.p - prev.p) * ratio;
        };

        // ==========================================
        // LEVEL 3: UI 元件 (Defined BEFORE App)
        // ==========================================

        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
                            <h3 className="font-bold">組件發生錯誤 (Component Crashed)</h3>
                            <pre className="text-xs mt-2 overflow-auto">{this.state.error && this.state.error.toString()}</pre>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const Icon = ({ path, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );
        const Icons = {
            Briefcase: (p) => <Icon {...p} path={<><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></>} />,
            Upload: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></>} />,
            Clipboard: (p) => <Icon {...p} path={<><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></>} />,
            Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>} />,
            Loader2: (p) => <Icon {...p} className={`animate-spin ${p.className}`} path={<><path d="M21 12a9 9 0 1 1-6.219-8.56"/></>} />,
            TrendingUp: (p) => <Icon {...p} path={<><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></>} />,
            PieChartIcon: (p) => <Icon {...p} path={<><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></>} />,
            Activity: (p) => <Icon {...p} path={<><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></>} />,
            Calendar: (p) => <Icon {...p} path={<><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></>} />,
            Layers: (p) => <Icon {...p} path={<><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></>} />,
            Check: (p) => <Icon {...p} path={<><polyline points="20 6 9 17 4 12"/></>} />,
            X: (p) => <Icon {...p} path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />,
            Edit2: (p) => <Icon {...p} path={<><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></>} />,
            ChevronLeft: (p) => <Icon {...p} path={<><path d="m15 18-6-6 6-6"/></>} />,
            ChevronRight: (p) => <Icon {...p} path={<><path d="m9 18 6-6-6-6"/></>} />,
        };

        const MetricCard = ({ title, value, subValue, trend }) => {
            const isUp = trend === 'up', isDown = trend === 'down';
            return (
                <div className="bg-white rounded-xl p-5 border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                    <div className="flex justify-between items-start mb-2"><p className="text-gray-500 text-sm font-medium">{title}</p>{trend && <div className={`px-2 py-0.5 rounded text-xs font-bold ${isUp?'bg-red-100 text-red-700':isDown?'bg-green-100 text-green-700':''}`}>{isUp?'▲':isDown?'▼':''}</div>}</div>
                    <h3 className="text-2xl font-bold text-gray-900 tracking-tight">{value}</h3>
                    {subValue && <div className={`mt-2 text-sm flex items-center font-medium ${isUp?'text-red-600':isDown?'text-green-600':'text-gray-600'}`}>{subValue}</div>}
                </div>
            );
        };

        const PasteModal = ({ isOpen, onClose, onPaste }) => {
            const [text, setText] = useState("");
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh]">
                        <div className="p-6 border-b border-gray-200 flex justify-between items-center"><h3 className="text-lg font-bold text-gray-900">貼上 CSV 資料</h3><button onClick={onClose}><Icons.X size={20}/></button></div>
                        <div className="p-6 flex-1 overflow-hidden"><textarea className="w-full h-64 p-3 border border-gray-300 rounded-lg font-mono text-xs resize-none" value={text} onChange={(e)=>setText(e.target.value)} /></div>
                        <div className="p-6 border-t bg-gray-50 flex justify-end gap-3"><button onClick={onClose} className="px-4 py-2 text-gray-700 bg-white border rounded-lg">取消</button><button onClick={()=>{onPaste(text);onClose();setText("")}} disabled={!text.trim()} className="px-4 py-2 text-white bg-blue-600 rounded-lg">匯入</button></div>
                    </div>
                </div>
            );
        };

        const EmptyState = ({ onImport, onPaste, onLoadDemo }) => (
            <div className="min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4">
                <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full text-center border border-gray-100">
                    <div className="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6"><Icons.Briefcase size={40} className="text-blue-600"/></div>
                    <h1 className="text-3xl font-bold text-gray-900 mb-3">投資組合儀表板</h1>
                    <div className="space-y-4">
                        <button onClick={onImport} className="w-full flex items-center justify-center gap-3 px-6 py-4 font-semibold text-white bg-blue-600 rounded-xl hover:bg-blue-700 shadow-lg"><Icons.Upload size={20}/>匯入 CSV 檔案</button>
                        <button onClick={onPaste} className="w-full flex items-center justify-center gap-3 px-6 py-4 font-semibold text-gray-700 bg-white border-2 rounded-xl hover:border-blue-300"><Icons.Clipboard size={20}/>貼上 CSV 文字</button>
                        <div className="relative py-2"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-200"></div></div><div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-gray-400">或是</span></div></div>
                        <button onClick={onLoadDemo} className="text-sm text-gray-500 hover:text-blue-600 font-medium">載入範例資料體驗看看</button>
                    </div>
                </div>
            </div>
        );

        const PdfTemplate = ({ data, selectedPortfolio, exchangeRate, formatMoney, formatUSD }) => {
            if (!data) return null;
            
            // 排序交易紀錄：最近到最早
            const currentYear = new Date().getFullYear();
            const yearTxs = data.transactions
                .filter(t => new Date(t['Transaction Date']).getFullYear() === currentYear)
                .sort((a, b) => new Date(b['Transaction Date']) - new Date(a['Transaction Date']));

            const pages = [];
            for (let i = 0; i < yearTxs.length; i += 15) pages.push(yearTxs.slice(i, i + 15));

            return (
                <div id="pdf-hidden-zone">
                    <div className="pdf-page">
                        <div className="flex justify-between items-end border-b-2 border-blue-600 pb-4 mb-6">
                            <div><h1 className="text-3xl font-extrabold text-gray-900">{selectedPortfolio}</h1><p className="text-gray-500 mt-1">年度投資績效報告 (Desktop View)</p></div>
                            <div className="text-right"><p className="text-sm text-gray-400">製表日期</p><p className="font-bold">{new Date().toLocaleDateString()}</p></div>
                        </div>
                        <div className="grid grid-cols-4 gap-6 mb-8">
                            <MetricCard title="目前市值" value={formatMoney(data.summary.totalValue, true)} subValue={`美金: ${formatUSD(data.summary.totalValue)}`} trend={data.summary.returnPcnt>=0?'up':'down'} />
                            <MetricCard title="淨投入本金" value={formatMoney(data.summary.totalCost, true)} subValue={`美金: ${formatUSD(data.summary.totalCost)}`} trend="neutral" />
                            <MetricCard title="總報酬" value={formatMoney(data.summary.totalReturn, true)} subValue={`${data.summary.returnPcnt>0?'+':''}${data.summary.returnPcnt.toFixed(2)}%`} trend={data.summary.totalReturn>=0?'up':'down'} />
                            <MetricCard title="XIRR" value={`${data.summary.annualizedReturn.toFixed(2)}%`} subValue="年化資金效率" trend={data.summary.annualizedReturn>0?'up':'down'} />
                        </div>
                        <div className="flex gap-4 h-[300px] mb-8">
                            <div className="flex-1 border rounded-lg p-4">
                                <h3 className="font-bold mb-4 text-gray-700">資產成長趨勢</h3>
                                <div style={{width:'750px', height:'240px'}}>
                                    <AreaChart width={750} height={240} data={data.chartData}>
                                        <XAxis dataKey="date" hide/><YAxis hide domain={['auto','auto']}/>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false}/>
                                        <Area type="monotone" dataKey="value" stroke="#3b82f6" fillOpacity={1} fill="#3b82f6" isAnimationActive={false} />
                                        <Area type="monotone" dataKey="invested" stroke="#10b981" strokeDasharray="5 5" fillOpacity={0} isAnimationActive={false} />
                                    </AreaChart>
                                </div>
                            </div>
                            <div className="w-1/3 border rounded-lg p-4">
                                <h3 className="font-bold mb-4 text-gray-700">資產配置</h3>
                                <div style={{width:'350px', height:'240px'}}>
                                    <PieChart width={350} height={240}>
                                        <Pie data={data.pieData} dataKey="value" cx="50%" cy="50%" innerRadius={50} outerRadius={70} paddingAngle={5} isAnimationActive={false} label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}>
                                            {data.pieData.map((e,i)=><Cell key={i} fill={e.color}/>)}
                                        </Pie>
                                    </PieChart>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div className="pdf-page">
                         <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-gray-800">個別資產明細 (Holdings)</h2></div>
                         <div className="border rounded-lg overflow-hidden">
                            <table className="w-full text-sm text-left whitespace-nowrap"><thead className="bg-gray-50 font-bold text-gray-600"><tr><th className="p-3">代號</th><th className="p-3 text-right">股數</th><th className="p-3 text-right">現價(原幣)</th><th className="p-3 text-right">總市值(TWD)</th><th className="p-3 text-right">報酬率</th></tr></thead><tbody>{data.holdings.map((h, i) => (<tr key={i} className="border-t border-gray-100"><td className="p-3 font-bold">{h.symbol}</td><td className="p-3 text-right">{h.shares.toFixed(2)}</td><td className="p-3 text-right">{h.price.toFixed(2)}</td><td className="p-3 text-right">{formatMoney(h.value, true)}</td><td className={`p-3 text-right font-bold ${h.returnPcnt>=0?'text-red-600':'text-green-600'}`}>{h.returnPcnt.toFixed(2)}%</td></tr>))}</tbody></table>
                        </div>
                    </div>

                    {pages.length > 0 ? pages.map((chunk, idx) => (
                        <div key={idx} className="pdf-page">
                            <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-gray-800">{currentYear} 年度交易紀錄</h2><span className="bg-gray-100 px-3 py-1 rounded text-sm text-gray-600">頁 {idx + 3}</span></div>
                            <table className="w-full text-sm text-left border rounded-lg overflow-hidden whitespace-nowrap"><thead className="bg-gray-50 font-bold text-gray-600"><tr><th className="p-4 border-b">日期</th><th className="p-4 border-b">類型</th><th className="p-4 border-b">標的</th><th className="p-4 border-b text-right">股數</th><th className="p-4 border-b text-right">單價</th><th className="p-4 border-b text-right">總額(USD)</th><th className="p-4 border-b text-right">總額(TWD)</th></tr></thead><tbody>{chunk.map((t, ti) => (<tr key={ti} className="border-b last:border-0 hover:bg-gray-50"><td className="p-4 text-gray-600">{t['Transaction Date'].split(' ')[0]}</td><td className="p-4"><span className={`px-2 py-1 rounded text-xs font-bold ${t.Type==='Buy'?'bg-red-100 text-red-700':t.Type.includes('Sell')?'bg-green-100 text-green-700':'bg-blue-100 text-blue-700'}`}>{TYPE_MAP[t.Type] || t.Type}</span></td><td className="p-4 font-bold">{t.Symbol}</td><td className="p-4 text-right font-mono">{parseFloat(t['Shares Owned']).toFixed(2)}</td><td className="p-4 text-right font-mono">{t.Currency === 'TWD' ? 'NT$' : '$'}{parseFloat(t['Cost Per Share']).toFixed(2)}</td><td className="p-4 text-right font-mono font-bold">{t.Currency === 'USD' ? '$' : ''}{t.amount ? Math.abs(t.amount).toLocaleString(undefined, {minimumFractionDigits:2}) : '-'}</td><td className="p-4 text-right font-mono font-bold text-gray-500">{t.amount ? formatMoney(Math.abs(t.amount), true) : '-'}</td></tr>))}</tbody></table>
                        </div>
                    )) : <div className="pdf-page flex items-center justify-center border-2 border-dashed"><p className="text-gray-400 text-xl">本年度尚無交易紀錄</p></div>}
                </div>
            );
        };

        // ==========================================
        // 4. App 主程式 (Defined LAST)
        // ==========================================

        const App = () => {
            const [rawData, setRawData] = useState(null);
            const [selectedPortfolio, setSelectedPortfolio] = useState("Firstrade 帳戶"); 
            const [timeRange, setTimeRange] = useState("ALL");
            const [priceOverrides, setPriceOverrides] = useState({});
            const [currentPage, setCurrentPage] = useState(1);
            const [isPasteModalOpen, setIsPasteModalOpen] = useState(false);
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
            const [exchangeRate, setExchangeRate] = useState(31.33); 
            const fileInputRef = useRef(null);
            const [editingSymbol, setEditingSymbol] = useState(null);
            const [editValue, setEditValue] = useState("");

            // Core Logic: Calculations
            const portfolioDataResult = useMemo(() => {
                if (!rawData) return null;
                try {
                    const allData = parseCSV(rawData);
                    let portfolioData = allData.filter(d => d.Portfolio === selectedPortfolio);
                    portfolioData.sort((a, b) => new Date(a['Transaction Date']) - new Date(b['Transaction Date']));

                    let portfolioCash = 0; 
                    let netInvestedPrincipal = 0; 

                    const holdingsMap = {}; 
                    const holdingsHistory = []; 
                    const xirrCashFlows = []; 
                    let mainCurrency = 'USD';

                    portfolioData.forEach(tx => {
                        const symbol = tx.Symbol;
                        if (symbol.includes('CASH')) return; 

                        const type = tx.Type;
                        const shares = parseFloat(tx['Shares Owned'] || 0);
                        let price = parseFloat(tx['Cost Per Share'] || 0);
                        const commission = parseFloat(tx.Commission || 0);
                        const dateObj = new Date(tx['Transaction Date']);
                        const dateTs = dateObj.getTime();
                        mainCurrency = tx.Currency || 'USD';

                        if (!holdingsMap[symbol]) holdingsMap[symbol] = { shares: 0, costBasis: 0, netInvested: 0, name: tx.Name, currency: tx.Currency };

                        let txnAmount = 0; 

                        if (type === 'Buy') {
                            const txnCost = (shares * price) + commission;
                            
                            // Cash Ledger
                            if (portfolioCash >= txnCost) {
                                portfolioCash -= txnCost;
                            } else {
                                const needed = txnCost - portfolioCash;
                                netInvestedPrincipal += needed;
                                portfolioCash = 0; 
                            }

                            holdingsMap[symbol].shares += shares;
                            holdingsMap[symbol].costBasis += txnCost;
                            holdingsMap[symbol].netInvested += txnCost; 
                            
                            xirrCashFlows.push({ amount: -txnCost, date: dateObj });
                            txnAmount = txnCost;

                        } else if (type.includes('Sell')) {
                            const sellProceeds = (shares * price) - commission;
                            portfolioCash += sellProceeds;

                            if (holdingsMap[symbol].shares > 0) {
                                const ratio = shares / holdingsMap[symbol].shares;
                                const costToRemove = holdingsMap[symbol].costBasis * ratio;
                                holdingsMap[symbol].costBasis -= costToRemove;
                                holdingsMap[symbol].netInvested -= costToRemove; 
                                holdingsMap[symbol].shares -= shares;
                            }
                            
                            xirrCashFlows.push({ amount: sellProceeds, date: dateObj });
                            txnAmount = sellProceeds;

                        } else if (type === 'Dividend Reinvest') {
                            const txnCost = (shares * price);
                            holdingsMap[symbol].shares += shares;
                            // Reinvest: no added cost basis for net invested principal view
                            txnAmount = txnCost;
                        }

                        if (price > 0) holdingsMap[symbol].currentPrice = price;
                        tx.amount = txnAmount;

                        const currentHoldingsSnapshot = {};
                        Object.keys(holdingsMap).forEach(s => { 
                            if (holdingsMap[s].shares > 0.000001) currentHoldingsSnapshot[s] = holdingsMap[s].shares; 
                        });
                        
                        holdingsHistory.push({ 
                            date: dateTs, 
                            holdings: currentHoldingsSnapshot, 
                            netInvested: netInvestedPrincipal,
                            cash: portfolioCash 
                        });
                    });

                    if (holdingsHistory.length === 0) return { summary: {}, chartData: [], holdings: [], transactions: [], pieData: [] };

                    // Chart Data
                    const firstDate = new Date(holdingsHistory[0].date);
                    const lastDate = new Date("2025-12-15");
                    const chartPoints = [];
                    let d = new Date(firstDate);
                    d.setDate(d.getDate() - d.getDay()); 

                    while (d <= lastDate) {
                        const currentTs = d.getTime();
                        let applicableSnapshot = null;
                        let currentNetInvestedPrincipal = 0;

                        for (let i = 0; i < holdingsHistory.length; i++) {
                            if (holdingsHistory[i].date <= currentTs) { 
                                applicableSnapshot = holdingsHistory[i].holdings; 
                                currentNetInvestedPrincipal = holdingsHistory[i].netInvested;
                            } else break;
                        }

                        if (applicableSnapshot) {
                            let totalVal = 0;
                            const dateStr = d.toISOString().split('T')[0];
                            Object.keys(applicableSnapshot).forEach(sym => {
                                const shareCount = applicableSnapshot[sym];
                                const priceAtDate = getInterpolatedPrice(sym, dateStr);
                                totalVal += shareCount * priceAtDate;
                            });
                            
                            if (totalVal > 0 || currentNetInvestedPrincipal > 0) {
                                chartPoints.push({ 
                                    date: dateStr, 
                                    rawDate: new Date(d), 
                                    value: totalVal, 
                                    invested: currentNetInvestedPrincipal 
                                });
                            }
                        }
                        d.setDate(d.getDate() + 7);
                    }
                    
                    const finalHoldings = holdingsHistory[holdingsHistory.length-1].holdings;
                    const finalNetInvested = holdingsHistory[holdingsHistory.length-1].netInvested;
                    let finalTotalVal = 0;
                    Object.keys(finalHoldings).forEach(sym => { finalTotalVal += finalHoldings[sym] * (CURRENT_PRICES[sym] || 0); });
                    
                    chartPoints.push({ 
                        date: "2025-12-15", 
                        rawDate: new Date("2025-12-15"), 
                        value: finalTotalVal, 
                        invested: finalNetInvested 
                    });

                    const totalCost = finalNetInvested;
                    const totalValue = finalTotalVal;

                    const holdingsArray = Object.keys(holdingsMap).map(sym => {
                        const h = holdingsMap[sym];
                        let finalPrice = CURRENT_PRICES[sym] || h.currentPrice;
                        if (priceOverrides[sym] !== undefined) finalPrice = parseFloat(priceOverrides[sym]);
                        const val = h.shares * finalPrice;
                        const retPcnt = h.costBasis > 0 ? ((val - h.costBasis) / h.costBasis) * 100 : 0;
                        return { 
                            ...h, 
                            symbol: sym, 
                            price: finalPrice, 
                            value: val, 
                            returnPcnt: retPcnt, 
                            avgCost: h.shares > 0 ? h.costBasis/h.shares : 0 
                        };
                    }).filter(h => h.shares > 0.001);

                    const now = new Date("2025-12-15");
                    let filteredChartData = chartPoints;
                    if (timeRange === 'YTD') filteredChartData = chartPoints.filter(p => p.rawDate >= new Date(now.getFullYear(), 0, 1));
                    else if (timeRange === '1Y') filteredChartData = chartPoints.filter(p => p.rawDate >= new Date(now.getFullYear() - 1, now.getMonth(), now.getDate()));
                    else if (timeRange === '3Y') filteredChartData = chartPoints.filter(p => p.rawDate >= new Date(now.getFullYear() - 3, now.getMonth(), now.getDate()));
                    else if (timeRange === '5Y') filteredChartData = chartPoints.filter(p => p.rawDate >= new Date(now.getFullYear() - 5, now.getMonth(), now.getDate()));

                    const xirrValue = calculateXIRR(xirrCashFlows, totalValue, now) * 100;
                    const sharpe = calculateSharpe(chartPoints);
                    const maxDrawdown = calculateMaxDrawdown(chartPoints);
                    const volatility = calculateVolatility(chartPoints);
                    const winRate = holdingsArray.length > 0 ? (holdingsArray.filter(h => h.returnPcnt >= 0).length / holdingsArray.length) * 100 : 0;
                    const pieData = holdingsArray.map((h, i) => ({ name: h.symbol, value: h.value, color: COLORS[i % COLORS.length] }));
                    const validTransactions = portfolioData.filter(t => !t.Symbol.includes('CASH') && Math.abs(t.amount) > 0.001);

                    return {
                        summary: { totalValue, totalCost, totalReturn: totalValue - totalCost, returnPcnt: totalCost > 0 ? ((totalValue - totalCost) / totalCost) * 100 : 0, currency: mainCurrency, annualizedReturn: xirrValue, sharpeRatio: sharpe, maxDrawdown, volatility, winRate, avgInvestAmt: totalCost, bestPerf: null, worstPerf: null },
                        chartData: filteredChartData, holdings: holdingsArray, transactions: validTransactions, pieData
                    };
                } catch (e) { console.error(e); return null; }
            }, [selectedPortfolio, rawData, priceOverrides, timeRange]);

            const portfolios = useMemo(() => {
                if(!rawData) return [];
                const all = parseCSV(rawData);
                return [...new Set(all.map(d => d.Portfolio).filter(Boolean))];
            }, [rawData]);

            const formatMoney = (amount, isTWD = false) => isTWD ? `NT$${Math.round(amount * exchangeRate).toLocaleString()}` : `$${amount.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            const formatUSD = (amount) => `$${amount.toLocaleString(undefined, {minimumFractionDigits: 2})}`;

            const handleDownloadPDF = async () => {
                if (isGeneratingPdf) return;
                setIsGeneratingPdf(true);
                await new Promise(r => setTimeout(r, 1000));
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('l', 'pt', 'a4');
                    const container = document.getElementById('pdf-hidden-zone');
                    const pages = container.querySelectorAll('.pdf-page');
                    for (let i = 0; i < pages.length; i++) {
                        if (i > 0) doc.addPage();
                        const canvas = await html2canvas(pages[i], { scale: 2, logging: false, useCORS: true });
                        doc.addImage(canvas.toDataURL('image/jpeg', 1.0), 'JPEG', 0, 0, doc.internal.pageSize.getWidth(), (canvas.height * doc.internal.pageSize.getWidth()) / canvas.width);
                    }
                    doc.save(`${selectedPortfolio}_Report.pdf`);
                } catch (e) { alert('PDF Error: ' + e.message); } finally { setIsGeneratingPdf(false); }
            };

            if (!rawData) {
                 return (<ErrorBoundary><PasteModal isOpen={isPasteModalOpen} onClose={() => setIsPasteModalOpen(false)} onPaste={setRawData} /><input type="file" ref={fileInputRef} onChange={(e) => { const f = e.target.files[0]; if(f) { const r = new FileReader(); r.onload=ev=>setRawData(ev.target.result); r.readAsText(f); } }} accept=".csv" className="hidden" /><EmptyState onImport={() => fileInputRef.current.click()} onPaste={() => setIsPasteModalOpen(true)} onLoadDemo={() => { setRawData(DEFAULT_CSV_DATA); setSelectedPortfolio("Firstrade 帳戶"); }} /></ErrorBoundary>);
            }
            if (!portfolioDataResult) return <div>Error</div>;

            const { summary, chartData, holdings, transactions: txs, pieData } = portfolioDataResult;
            const currentTxs = [...txs].reverse().slice((currentPage-1)*10, currentPage*10);

            return (
                <ErrorBoundary>
                    <div className="min-h-screen bg-gray-50 text-gray-900 font-sans pb-12">
                        <PasteModal isOpen={isPasteModalOpen} onClose={() => setIsPasteModalOpen(false)} onPaste={setRawData} />
                        <nav className="border-b border-gray-200 bg-white sticky top-0 z-50 shadow-sm"><div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"><div className="flex items-center justify-between h-16"><div className="flex items-center gap-2 cursor-pointer" onClick={() => setRawData(null)}><div className="bg-blue-600 p-1.5 rounded-lg"><Icons.Briefcase size={20} className="text-white" /></div><span className="font-bold text-xl tracking-tight text-gray-900">Portfolio<span className="text-blue-600">Viz</span></span></div><div className="flex items-center gap-3"><div className="flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-lg border border-gray-200"><span className="text-sm font-bold text-gray-500">USD/TWD</span><input type="number" value={exchangeRate} onChange={(e) => setExchangeRate(parseFloat(e.target.value))} className="w-16 bg-transparent text-sm font-mono font-bold text-blue-600 focus:outline-none text-right" /></div><button onClick={() => setIsPasteModalOpen(true)} className="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hidden sm:flex"><Icons.Clipboard size={16} /><span>貼上</span></button><button onClick={() => fileInputRef.current.click()} className="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hidden sm:flex"><Icons.Upload size={16} /><span>匯入</span></button><input type="file" ref={fileInputRef} onChange={(e)=>{ const f = e.target.files[0]; if(f) { const r = new FileReader(); r.onload=ev=>setRawData(ev.target.result); r.readAsText(f); } }} accept=".csv" className="hidden" /><button onClick={handleDownloadPDF} disabled={isGeneratingPdf} className="flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-colors disabled:opacity-70 disabled:cursor-not-allowed min-w-[110px] justify-center">{isGeneratingPdf ? <Icons.Loader2 size={16} className="animate-spin"/> : <Icons.Download size={16} />}<span>{isGeneratingPdf ? "生成中..." : "下載 PDF"}</span></button></div></div></div></nav>
                        <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8 bg-gray-50">
                            <div className="flex flex-col md:flex-row md:items-end justify-between gap-4"><div><div className="flex items-center gap-3 mb-1"><h1 className="text-3xl font-extrabold text-gray-900">{selectedPortfolio}</h1><select value={selectedPortfolio} onChange={(e) => { setSelectedPortfolio(e.target.value); setCurrentPage(1); }} className="bg-gray-100 text-sm font-medium px-2 py-1 rounded border border-gray-300 cursor-pointer outline-none focus:ring-2 focus:ring-blue-500">{portfolios.map(p => <option key={p} value={p}>{p}</option>)}</select></div><p className="text-gray-500 text-sm">投資組合深度分析報告 • 結算日 2025/12/15</p></div></div>
                            
                            {/* Summary Cards */}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <MetricCard title="目前市值" value={formatMoney(summary.totalValue, true)} subValue={`美金: ${formatUSD(summary.totalValue)}`} trend={summary.returnPcnt >= 0 ? 'up' : 'down'} />
                                <MetricCard title="淨投入本金" value={formatMoney(summary.totalCost, true)} subValue={`美金: ${formatUSD(summary.totalCost)}`} trend="neutral" />
                                <MetricCard title="總報酬" value={formatMoney(summary.totalReturn, true)} subValue={`${summary.returnPcnt > 0 ? '+' : ''}${summary.returnPcnt.toFixed(2)}%`} trend={summary.totalReturn >= 0 ? 'up' : 'down'} />
                                <MetricCard title="內部報酬率 (XIRR)" value={`${summary.annualizedReturn.toFixed(2)}%`} subValue="年化資金效率" trend={summary.annualizedReturn > 0 ? 'up' : 'down'} />
                            </div>

                            {/* Risk Metrics */}
                            <div className="bg-blue-50 rounded-xl p-6 border border-blue-100">
                                <div className="flex justify-between items-center mb-6"><h3 className="text-blue-900 font-bold flex items-center gap-2"><Icons.Activity size={20} /> 進階風險指標 (Risk Metrics)</h3><div className="flex items-center gap-2 text-blue-700 text-xs font-mono bg-blue-100 px-2 py-1 rounded"><span>匯率基準: {exchangeRate}</span></div></div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 border-b border-blue-200 pb-6">
                                    <div className="flex flex-col"><span className="text-blue-600 text-sm font-medium">最大回撤</span><span className="text-2xl font-bold text-gray-900">-{summary.maxDrawdown.toFixed(2)}%</span></div>
                                    <div className="flex flex-col"><span className="text-blue-600 text-sm font-medium">波動率</span><span className="text-2xl font-bold text-gray-900">{summary.volatility.toFixed(2)}%</span></div>
                                    <div className="flex flex-col"><span className="text-blue-600 text-sm font-medium">夏普比率</span><span className="text-2xl font-bold text-gray-900">{summary.sharpeRatio.toFixed(2)}</span></div>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div><span className="text-blue-600 text-xs font-medium block">獲利勝率</span><span className="text-lg font-bold text-gray-800">{summary.winRate.toFixed(1)}%</span></div>
                                    <div><span className="text-blue-600 text-xs font-medium block">平均投入</span><span className="text-lg font-bold text-gray-800">{formatMoney(summary.avgInvestAmt, summary.currency, false)}</span></div>
                                </div>
                            </div>

                            {/* Charts */}
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div className="lg:col-span-2 bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
                                    <div className="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                                        <h3 className="text-lg font-bold text-gray-900 flex items-center gap-2"><Icons.TrendingUp size={20} className="text-blue-600" />資產成長趨勢 (至 2025/12/15)</h3>
                                        <div className="flex bg-gray-100 rounded-lg p-1 overflow-x-auto">{['YTD', '1Y', '3Y', '5Y', 'ALL'].map((range) => (<button key={range} onClick={() => setTimeRange(range)} className={`px-3 py-1 text-xs font-medium rounded-md transition-all whitespace-nowrap ${timeRange === range ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>{range === 'YTD' ? '今年' : range === 'ALL' ? '全部' : range.replace('Y', '年')}</button>))}</div>
                                    </div>
                                    <div className="h-[300px] w-full">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <AreaChart data={chartData}>
                                                <defs><linearGradient id="colorValue" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#3b82f6" stopOpacity={0.2}/><stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/></linearGradient></defs>
                                                <XAxis dataKey="date" minTickGap={40} tick={{fontSize:12}} /><YAxis tickFormatter={v=>`${v/1000}k`} />
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} /><Tooltip formatter={v=>Math.round(v).toLocaleString()} />
                                                <Area type="monotone" dataKey="value" name="市值" stroke="#3b82f6" fillOpacity={1} fill="url(#colorValue)" />
                                                <Area type="monotone" dataKey="invested" name="成本" stroke="#10b981" strokeDasharray="5 5" fillOpacity={0} />
                                            </AreaChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                                <div className="bg-white rounded-xl p-6 border border-gray-200 shadow-sm flex flex-col">
                                    <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2"><Icons.PieChartIcon size={20} className="text-indigo-600" />資產配置</h3>
                                    <div className="flex-1 min-h-[200px]">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <PieChart><Pie data={pieData} dataKey="value" cx="50%" cy="50%" innerRadius={50} outerRadius={70} paddingAngle={5}>{pieData.map((e,i)=><Cell key={i} fill={e.color}/>)}</Pie><Tooltip formatter={v=>Math.round(v).toLocaleString()} /><Legend verticalAlign="middle" align="right" layout="vertical" /></PieChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                            </div>

                            {/* Holdings Table */}
                            <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                                <div className="p-6 border-b border-gray-200"><h3 className="text-lg font-bold text-gray-900 flex items-center gap-2"><Icons.Layers size={20} className="text-purple-600" />個別資產明細</h3><p className="text-xs text-gray-500 mt-1">現價已更新至 2025/12/15 收盤價，可手動修改。</p></div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left text-sm"><thead className="bg-gray-50 text-gray-500 font-semibold border-b border-gray-200"><tr><th className="px-6 py-3">代號</th><th className="px-6 py-3 text-right">股數</th><th className="px-6 py-3 text-right">均價 (原幣)</th><th className="px-6 py-3 text-right">現價 (原幣)</th><th className="px-6 py-3 text-right">總市值</th><th className="px-6 py-3 text-right">報酬率</th></tr></thead><tbody className="divide-y divide-gray-100">{holdings.map((h) => (<tr key={h.symbol} className="hover:bg-gray-50 transition-colors"><td className="px-6 py-4 font-bold text-gray-900">{h.symbol}</td><td className="px-6 py-4 text-right font-mono">{h.shares.toFixed(2)}</td><td className="px-6 py-4 text-right font-mono text-gray-600">{h.currency === 'TWD' ? 'NT$' : '$'}{h.avgCost.toFixed(2)}</td><td className="px-6 py-4 text-right font-mono">{editingSymbol === h.symbol ? (<div className="flex items-center justify-end gap-1"><input type="number" value={editValue} onChange={(e) => setEditValue(e.target.value)} className="w-20 px-1 py-0.5 border border-blue-400 rounded text-right" autoFocus /><button onClick={() => { if (editValue && !isNaN(editValue)) setPriceOverrides(prev => ({...prev, [h.symbol]: parseFloat(editValue)})); setEditingSymbol(null); }} className="text-green-600"><Icons.Check size={14}/></button><button onClick={() => setEditingSymbol(null)} className="text-red-500"><Icons.X size={14}/></button></div>) : (<div className="flex items-center justify-end gap-2 group"><span className={priceOverrides[h.symbol] || CURRENT_PRICES[h.symbol] ? "text-blue-600 font-bold" : ""}>{h.currency === 'TWD' ? 'NT$' : '$'}{h.price.toFixed(2)}</span><button onClick={() => { setEditingSymbol(h.symbol); setEditValue(h.price); }} className="text-gray-400 hover:text-blue-600 opacity-0 group-hover:opacity-100"><Icons.Edit2 size={14} /></button></div>)}</td><td className="px-6 py-4 text-right font-bold font-mono"><div><div className="font-bold text-gray-900">{h.currency === 'TWD' ? `NT$${h.value.toLocaleString(undefined, {minimumFractionDigits: 2})}` : `$${h.value.toLocaleString(undefined, {minimumFractionDigits: 2})}`}</div>{h.currency !== 'TWD' && <div className="text-xs text-gray-500">{formatMoney(h.value, true)}</div>}</div></td><td className="px-6 py-4 text-right font-mono"><span className={`px-2 py-1 rounded text-xs font-bold ${h.returnPcnt >= 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`}>{h.returnPcnt > 0 ? '+' : ''}{h.returnPcnt.toFixed(2)}%</span></td></tr>))}</tbody></table>
                                </div>
                            </div>

                            {/* Transactions Table */}
                            <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                                <div className="p-6 border-b border-gray-200 flex justify-between items-center"><h3 className="text-lg font-bold text-gray-900 flex items-center gap-2"><Icons.Calendar size={20} className="text-orange-500" /> 交易紀錄 <span className="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full">共 {txs.length} 筆</span></h3><div className="flex items-center gap-2"><button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1} className="p-1 rounded hover:bg-gray-100 disabled:opacity-50"><Icons.ChevronLeft size={16} /></button><span className="text-sm text-gray-600">頁 {currentPage} / {Math.ceil(txs.length / 10)}</span><button onClick={() => setCurrentPage(p => Math.min(Math.ceil(txs.length / 10), p + 1))} disabled={currentPage === Math.ceil(txs.length / 10)} className="p-1 rounded hover:bg-gray-100 disabled:opacity-50"><Icons.ChevronRight size={16} /></button></div></div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left text-sm whitespace-nowrap"><thead className="bg-gray-50 text-gray-500 font-semibold"><tr><th className="px-6 py-3">日期</th><th className="px-6 py-3">代號</th><th className="px-6 py-3">類型</th><th className="px-6 py-3 text-right">股數</th><th className="px-6 py-3 text-right">單價</th><th className="px-6 py-3 text-right">總額</th></tr></thead><tbody className="divide-y divide-gray-100">{currentTxs.map((tx, i) => (<tr key={i} className="hover:bg-gray-50"><td className="px-6 py-3">{tx['Transaction Date'].split(' ')[0]}</td><td className="px-6 py-3 font-bold">{tx.Symbol}</td><td className="px-6 py-3"><span className={`px-2 py-1 rounded text-xs ${tx.Type === 'Buy' ? 'bg-red-100 text-red-700' : tx.Type.includes('Sell') ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{TYPE_MAP[tx.Type] || tx.Type}</span></td><td className="px-6 py-3 text-right font-mono">{parseFloat(tx['Shares Owned']).toFixed(2)}</td><td className="px-6 py-3 text-right font-mono">{tx.Currency === 'TWD' ? 'NT$' : '$'}{parseFloat(tx['Cost Per Share']).toFixed(2)}</td><td className="px-6 py-3 text-right font-mono font-bold">{tx.Currency === 'TWD' ? 'NT$' : '$'}{tx.amount ? Math.abs(tx.amount).toLocaleString(undefined, {minimumFractionDigits:2}) : '-'}</td></tr>))}</tbody></table>
                                </div>
                            </div>
                        </main>
                        <div id="pdf-hidden-zone"><PdfTemplate data={portfolioDataResult} selectedPortfolio={selectedPortfolio} exchangeRate={exchangeRate} formatMoney={formatMoney} formatUSD={formatUSD} /></div>
                    </div>
                </ErrorBoundary>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>